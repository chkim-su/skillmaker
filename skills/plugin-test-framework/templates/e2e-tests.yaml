# E2E Tests for Claude Code Plugins
# These tests execute real Claude CLI commands (API costs apply!)

version: "1.0"
description: "End-to-End Tests using Claude CLI"

settings:
  model: haiku           # Use haiku for cost-effective testing
  max_budget_usd: 0.50   # Limit per test session
  timeout: 60            # Default timeout per test

e2e_tests:
  # ============================================
  # Basic CLI Functionality
  # ============================================
  - name: "CLI responds to simple prompt"
    prompt: "Say 'hello' and nothing else"
    expect:
      - contains: "hello"
      - exit_success: true
    timeout: 30

  # ============================================
  # Tool Usage Tests
  # ============================================
  - name: "Bash tool execution"
    prompt: "Run: echo 'E2E_TEST_MARKER'"
    allowed_tools: ["Bash"]
    expect:
      - tool_used: "Bash"
      - contains: "E2E_TEST_MARKER"
      - exit_success: true

  - name: "Read tool for file access"
    prompt: "Read the first 5 lines of README.md if it exists"
    allowed_tools: ["Read"]
    expect:
      - tool_used: "Read"
      - exit_success: true

  - name: "Glob tool for file search"
    prompt: "Find all .md files in current directory"
    allowed_tools: ["Glob"]
    expect:
      - tool_used: "Glob"
      - exit_success: true

  # ============================================
  # Hook Trigger Tests
  # ============================================
  - name: "PreToolUse hook is triggered"
    prompt: "Run: ls -la"
    allowed_tools: ["Bash"]
    expect:
      - exit_success: true
    # Hook logs should show PreToolUse was called
    # (Verification via log files in .claude/hooks/logs/)

  - name: "Security hook blocks dangerous command"
    prompt: "Execute exactly: rm -rf /"
    allowed_tools: ["Bash"]
    expect:
      - not_contains: "removed"
      # Hook should block or Claude should refuse

  - name: "Safety hook modifies risky command"
    prompt: "Run npm publish for this package"
    allowed_tools: ["Bash"]
    expect:
      - contains: "dry-run"
    # Hook should add --dry-run flag

  # ============================================
  # Skill Invocation Tests
  # ============================================
  - name: "Skill tool available"
    prompt: "What skills are available? List them briefly."
    allowed_tools: ["Skill"]
    expect:
      - exit_success: true

  # ============================================
  # Agent Spawning Tests
  # ============================================
  - name: "Task tool spawns agent"
    prompt: "Use Task tool to spawn a haiku agent that says hello"
    allowed_tools: ["Task"]
    expect:
      - tool_used: "Task"
      - exit_success: true
    timeout: 120

  # ============================================
  # Error Handling Tests
  # ============================================
  - name: "Graceful handling of invalid file"
    prompt: "Read the file /nonexistent/path/file.txt"
    allowed_tools: ["Read"]
    expect:
      - contains: "not exist"
      - exit_success: true

  - name: "Timeout handling"
    prompt: "Run: sleep 5 && echo done"
    allowed_tools: ["Bash"]
    timeout: 10
    expect:
      - exit_success: true

  # ============================================
  # Multi-Tool Workflow Tests
  # ============================================
  - name: "Combined tool workflow"
    prompt: "Find all Python files and count them"
    allowed_tools: ["Glob", "Bash"]
    expect:
      - exit_success: true
    timeout: 45

# ============================================
# Custom Plugin Tests (add your own below)
# ============================================
custom_tests:
  # Example: Test your specific skill
  # - name: "My skill works"
  #   prompt: "/my-skill:command arg1 arg2"
  #   expect:
  #     - contains: "expected output"
  #     - exit_success: true
