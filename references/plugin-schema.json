{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://skillmaker.dev/schemas/plugin-structure.json",
  "title": "Claude Code Plugin Structure Schema",
  "description": "Formal schema for Claude Code plugin validation",

  "definitions": {
    "kebab-case": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9]*(-[a-z0-9]+)*$",
      "description": "Lowercase with hyphens only (e.g., 'my-plugin')"
    },

    "relative-path": {
      "type": "string",
      "pattern": "^\\.\\/",
      "description": "Must start with './' (e.g., './', './path/to/item')"
    },

    "command-path": {
      "type": "string",
      "pattern": "^\\.\\/.*\\.md$",
      "description": "Commands are .md files (e.g., './commands/migrate.md')"
    },

    "agent-path": {
      "type": "string",
      "pattern": "^\\.\\/.*\\.md$",
      "description": "Agents are .md files (e.g., './agents/my-agent.md')"
    },

    "skill-path": {
      "type": "string",
      "pattern": "^\\.\\/[^.]+$|^\\.\\/.*[^d]\\.m$",
      "not": { "pattern": "\\.md$" },
      "description": "Skills are directories, NOT .md files (e.g., './skills/my-skill')"
    },

    "hook-path": {
      "type": "string",
      "pattern": "^\\.\\/.*\\.json$",
      "description": "Hooks are .json files (e.g., './hooks/hooks.json')"
    },

    "github-source": {
      "type": "object",
      "required": ["source", "repo"],
      "properties": {
        "source": { "const": "github" },
        "repo": {
          "type": "string",
          "pattern": "^[^/]+/[^/]+$",
          "description": "Format: owner/repo"
        }
      },
      "additionalProperties": false
    },

    "url-source": {
      "type": "object",
      "required": ["source", "url"],
      "properties": {
        "source": { "const": "url" },
        "url": {
          "type": "string",
          "pattern": "^https?://",
          "description": "Must be http:// or https://"
        }
      },
      "additionalProperties": false
    },

    "path-source": {
      "$ref": "#/definitions/relative-path"
    },

    "plugin-source": {
      "oneOf": [
        { "$ref": "#/definitions/path-source" },
        { "$ref": "#/definitions/github-source" },
        { "$ref": "#/definitions/url-source" }
      ],
      "description": "Source: path ('./'), GitHub ({source:'github',repo:'...'}), or URL"
    },

    "owner": {
      "type": "object",
      "required": ["name"],
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "email": { "type": "string", "format": "email" },
        "url": { "type": "string", "format": "uri" }
      },
      "additionalProperties": false
    },

    "author": {
      "type": "object",
      "required": ["name"],
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "email": { "type": "string", "format": "email" }
      },
      "additionalProperties": false
    },

    "plugin": {
      "type": "object",
      "required": ["name", "source"],
      "properties": {
        "name": { "$ref": "#/definitions/kebab-case" },
        "source": { "$ref": "#/definitions/plugin-source" },
        "description": { "type": "string" },
        "version": { "type": "string", "pattern": "^\\d+\\.\\d+\\.\\d+" },
        "author": { "$ref": "#/definitions/author" },
        "homepage": { "type": "string", "format": "uri" },
        "repository": {
          "type": "string",
          "description": "MUST be string URL, NOT object"
        },
        "license": { "type": "string" },
        "keywords": { "type": "array", "items": { "type": "string" } },
        "category": { "type": "string" },
        "tags": { "type": "array", "items": { "type": "string" } },
        "strict": { "type": "boolean" },
        "commands": {
          "type": "array",
          "items": { "$ref": "#/definitions/command-path" }
        },
        "agents": {
          "type": "array",
          "items": { "$ref": "#/definitions/agent-path" }
        },
        "skills": {
          "type": "array",
          "items": { "$ref": "#/definitions/skill-path" }
        },
        "hooks": {
          "type": "array",
          "items": { "$ref": "#/definitions/hook-path" }
        },
        "mcpServers": { "type": ["string", "object"] },
        "lspServers": { "type": ["string", "object"] }
      },
      "additionalProperties": false,
      "errorMessage": {
        "additionalProperties": "Unknown field. Allowed: name, source, description, version, author, homepage, repository, license, keywords, category, tags, strict, commands, agents, skills, hooks, mcpServers, lspServers"
      }
    }
  },

  "type": "object",
  "required": ["name", "owner", "plugins"],
  "properties": {
    "$schema": { "type": "string" },
    "name": {
      "$ref": "#/definitions/kebab-case",
      "description": "Marketplace identifier (kebab-case)"
    },
    "owner": { "$ref": "#/definitions/owner" },
    "plugins": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/definitions/plugin" }
    },
    "description": { "type": "string" },
    "version": { "type": "string" },
    "homepage": { "type": "string", "format": "uri" },
    "metadata": {
      "type": "object",
      "properties": {
        "description": { "type": "string" },
        "version": { "type": "string" },
        "pluginRoot": { "type": "string" }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
